<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart OS Cloud - V5.0 Master CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @media print { .no-print { display: none !important; } body { background: white; } }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 p-4 font-sans text-slate-800">

    <div id="tela-login" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100]">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 text-center border-t-8 border-blue-600">
            <h2 class="text-3xl font-black mb-6 text-slate-800 tracking-tighter">SISTEMA OS</h2>
            <input type="email" id="login-email" placeholder="E-mail" class="w-full border p-3 mb-4 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50">
            <input type="password" id="login-senha" placeholder="Senha" class="w-full border p-3 mb-6 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50">
            <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg">Acessar Painel</button>
        </div>
    </div>

    <div class="flex justify-between items-center mb-6 no-print max-w-6xl mx-auto">
        <div>
            <h1 class="text-2xl font-black text-slate-800 tracking-tighter uppercase italic">Smart OS <span class="text-blue-600 italic">Cloud</span></h1>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Controle de Fluxo & Clientes v5.0</p>
        </div>
        <div class="flex gap-2">
            <button onclick="alternarVisaoClientes()" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-50 transition flex items-center gap-2 shadow-sm">
                ðŸ‘¥ <span id="btn-cliente-texto">Gerenciar Clientes</span>
            </button>
            <button onclick="fazerLogout()" class="bg-red-50 text-red-500 px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-100 transition shadow-sm">Sair</button>
        </div>
    </div>
    
    <div class="container mx-auto max-w-6xl">
        
        <div id="sessao-dashboard" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 no-print">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-64 flex flex-col items-center">
                <h3 class="text-[10px] font-black text-slate-400 mb-4 uppercase tracking-widest">Volume de Ordens</h3>
                <canvas id="graficoBarras"></canvas>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-64 flex flex-col items-center">
                <h3 class="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">DistribuiÃ§Ã£o de Status (%)</h3>
                <div class="relative w-full h-32">
                    <canvas id="graficoRosca"></canvas>
                </div>
                <div id="legenda-percentual" class="mt-6 text-[9px] font-bold text-slate-500 flex gap-4 uppercase"></div>
            </div>
        </div>

        <div id="sessao-clientes" class="hidden mb-8 no-print animate-in fade-in slide-in-from-top-4 duration-300">
            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-emerald-500">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-black text-slate-800 uppercase text-sm italic">Base de Dados de Clientes</h2>
                    <input type="text" id="busca-cliente" onkeyup="filtrarTabelaClientes()" placeholder="Filtrar cliente..." class="border p-2 rounded-lg text-xs w-64 outline-none focus:ring-1 focus:ring-emerald-500">
                </div>
                <div class="overflow-x-auto max-h-64 custom-scroll">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-50 text-slate-500 uppercase font-bold sticky top-0">
                            <tr>
                                <th class="p-3">Nome</th>
                                <th class="p-3">Contato</th>
                                <th class="p-3">E-mail</th>
                                <th class="p-3">EndereÃ§o</th>
                                <th class="p-3 text-center">AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-clientes-corpo" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="md:col-span-1 no-print">
                <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-600" id="form-container">
                    <h2 id="titulo-form" class="text-xs font-black mb-5 text-blue-600 uppercase tracking-widest">Nova Ordem de ServiÃ§o</h2>
                    <div class="space-y-3">
                        <input type="hidden" id="edit-id">
                        
                        <div class="relative">
                            <input type="text" id="cliente" list="lista-clientes-sugestao" oninput="checarClienteExistente(this.value)" placeholder="Nome do Cliente" autocomplete="off" name="c_name_v5" class="w-full border p-2.5 rounded-lg text-sm outline-none focus:border-blue-500 bg-slate-50 font-semibold">
                            <datalist id="lista-clientes-sugestao"></datalist>
                        </div>

                        <input type="text" id="contato" placeholder="WhatsApp / Telefone" autocomplete="off" name="c_phone_v5" class="w-full border p-2.5 rounded-lg text-sm outline-none focus:border-blue-500 bg-slate-50">
                        <input type="email" id="email" placeholder="E-mail" autocomplete="off" name="c_mail_v5" class="w-full border p-2.5 rounded-lg text-sm outline-none focus:border-blue-500 bg-slate-50">
                        <input type="text" id="endereco" placeholder="EndereÃ§o Completo" autocomplete="off" name="c_end_v5" class="w-full border p-2.5 rounded-lg text-sm outline-none focus:border-blue-500 bg-slate-50">
                        
                        <div class="pt-2">
                            <input type="text" id="equipamento" placeholder="Equipamento (Ex: Notebook Dell)" class="w-full border p-2.5 rounded-lg text-sm outline-none focus:border-blue-500 mb-3 shadow-inner">
                            <textarea id="descricao" placeholder="Relato do problema..." class="w-full border p-2.5 rounded-lg text-sm h-24 outline-none focus:border-blue-500 bg-white resize-none"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div class="relative">
                                <span class="absolute left-3 top-2.5 text-slate-400 text-sm">R$</span>
                                <input type="number" id="valor" placeholder="0,00" class="w-full border pl-9 p-2.5 rounded-lg text-sm outline-none focus:border-blue-500 font-bold">
                            </div>
                            <select id="status" class="w-full border p-2.5 rounded-lg text-sm outline-none focus:border-blue-500 bg-white font-black text-slate-600">
                                <option value="Pendente">ðŸŸ¡ Pendente</option>
                                <option value="Em Andamento">ðŸ”µ Em Andamento</option>
                                <option value="ConcluÃ­do">ðŸŸ¢ ConcluÃ­do</option>
                            </select>
                        </div>
                        
                        <button onclick="salvarNoSupabase()" id="btn-salvar" class="w-full bg-blue-600 text-white font-black py-3 rounded-lg hover:bg-blue-700 transition shadow-lg uppercase text-xs tracking-widest mt-2">Salvar Registro</button>
                        <button id="btn-cancelar" onclick="cancelarEdicao()" class="w-full bg-slate-400 text-white font-bold py-2 rounded-lg hidden transition mt-2 text-[10px] uppercase">Cancelar EdiÃ§Ã£o</button>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-md mt-6 border-b-4 border-slate-300">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-[10px] uppercase text-slate-400 tracking-tighter">Ãšltimas OS</h3>
                        <button onclick="carregarOrdens()" class="text-blue-500 text-[10px] font-bold">Atualizar â†»</button>
                    </div>
                    <input type="text" id="busca" onkeyup="filtrarOrdens()" placeholder="Buscar OS..." class="w-full border p-2 rounded-lg text-xs mb-4 outline-none bg-slate-50 focus:bg-white">
                    <ul id="lista-os" class="space-y-2 text-sm max-h-60 overflow-y-auto custom-scroll pr-1"></ul>
                </div>
            </div>

            <div class="md:col-span-2">
                <div id="area-os" class="bg-white p-12 rounded-xl shadow-2xl hidden min-h-[700px] relative border border-slate-100">
                    <div class="flex justify-between border-b-4 border-slate-800 pb-8 mb-10">
                        <div>
                            <h1 class="text-4xl font-black uppercase italic text-slate-800 leading-none tracking-tighter">Ordem de ServiÃ§o</h1>
                            <p class="text-blue-500 text-xs font-black mt-2 tracking-[0.3em] uppercase">Documento de Controle</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-3xl text-slate-800 leading-none" id="view-numero"></p>
                            <p class="text-[10px] text-slate-400 font-bold mt-2 uppercase tracking-widest" id="view-data"></p>
                            <div class="inline-block mt-3 px-4 py-1.5 rounded-full text-[10px] font-black border-2 uppercase" id="view-status-tag">STATUS: <span id="view-status"></span></div>
                        </div>
                    </div>
                    
                    <div class="space-y-10">
                        <div class="grid grid-cols-2 gap-12">
                            <div class="space-y-2">
                                <p class="text-[10px] uppercase font-black text-slate-300">ProprietÃ¡rio / Cliente</p>
                                <p id="view-cliente" class="text-xl font-black uppercase text-slate-800"></p>
                                <div class="text-sm space-y-1 text-slate-500 font-medium">
                                    <p id="view-contato"></p>
                                    <p id="view-email"></p>
                                    <p id="view-endereco" class="italic"></p>
                                </div>
                            </div>
                            <div class="space-y-2">
                                <p class="text-[10px] uppercase font-black text-slate-300">Equipamento Avaliado</p>
                                <p id="view-equipamento" class="text-xl font-black uppercase text-blue-900"></p>
                            </div>
                        </div>

                        <div>
                            <p class="font-black mb-3 text-[10px] uppercase text-slate-300 tracking-widest">Parecer TÃ©cnico & DiagnÃ³stico</p>
                            <div id="view-descricao" class="p-8 bg-slate-50 rounded-2xl min-h-[200px] whitespace-pre-wrap text-sm leading-relaxed border border-slate-100 italic text-slate-700"></div>
                        </div>

                        <div class="flex justify-end">
                            <div class="bg-slate-900 text-white px-10 py-6 rounded-3xl shadow-2xl text-right min-w-[250px] border-b-8 border-blue-600">
                                <p class="text-[10px] uppercase font-bold text-slate-400 mb-1 tracking-widest">Valor do Investimento</p>
                                <p class="text-4xl font-black">R$ <span id="view-valor"></span></p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-40 border-t-2 border-slate-100 pt-10 flex justify-between gap-20 text-[10px] uppercase font-black text-slate-300 italic">
                        <div class="flex-1 border-t-2 border-slate-800 pt-3 text-center">Assinatura de Retirada</div>
                        <div class="flex-1 border-t-2 border-slate-800 pt-3 text-center text-blue-600">TÃ©cnico ResponsÃ¡vel</div>
                    </div>
                    
                    <button onclick="window.print()" class="no-print mt-12 bg-blue-600 text-white px-12 py-4 rounded-xl font-black hover:bg-blue-700 shadow-xl transition w-full text-xs uppercase tracking-[0.3em]">Finalizar e Imprimir Via</button>
                </div>
                
                <div id="aviso-vazio" class="flex flex-col items-center justify-center h-[500px] text-slate-300 border-2 border-dashed border-slate-200 rounded-3xl">
                    <span class="text-6xl mb-4">ðŸ“‘</span>
                    <p class="font-black uppercase text-xs tracking-widest">Selecione uma OS para visualizar</p>
                </div>
            </div>
        </div>
    </div>

<script>
    const SUPABASE_URL = 'https://awuuucqzhgmyuolqrifm.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_M5bgMFw0R1rWLe5nfofFeg_NwLkjbBh'; 
    const supaClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let chartBarras = null, chartRosca = null, listaClientesGlobal = [], minhasOrdens = [];

    async function fazerLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-senha').value;
        try {
            const { error } = await supaClient.auth.signInWithPassword({ email, password });
            if (error) throw error;
            verificarSessao();
        } catch (err) { alert("Acesso InvÃ¡lido: " + err.message); }
    }

    async function verificarSessao() {
        const { data: { session } } = await supaClient.auth.getSession();
        if (session) { 
            document.getElementById('tela-login').classList.add('hidden'); 
            await carregarClientes(); 
            await carregarOrdens(); 
        } else { document.getElementById('tela-login').classList.remove('hidden'); }
    }

    function fazerLogout() { supaClient.auth.signOut(); window.location.reload(); }

    // --- CRM: GESTÃƒO DE CLIENTES ---
    async function carregarClientes() {
        const { data, error } = await supaClient.from('clientes').select('*').order('nome');
        if (!error) {
            listaClientesGlobal = data;
            document.getElementById('lista-clientes-sugestao').innerHTML = data.map(c => `<option value="${c.nome}">`).join('');
            atualizarTabelaClientes(data);
        }
    }

    function atualizarTabelaClientes(dados) {
        const corpo = document.getElementById('tabela-clientes-corpo');
        corpo.innerHTML = dados.map(c => `
            <tr class="hover:bg-slate-50 transition">
