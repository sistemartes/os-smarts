<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de OS Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>@media print { .no-print { display: none; } }</style>
</head>
<body class="bg-gray-100 p-4">

    <div id="tela-login" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-96">
        <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Acesso Restrito</h2>
        <input type="email" id="login-email" placeholder="E-mail" class="w-full border p-2 mb-4 rounded">
        <input type="password" id="login-senha" placeholder="Senha" class="w-full border p-2 mb-6 rounded">
        <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">Entrar</button>
    </div>
</div>

    <div class="flex justify-between items-center mb-6 no-print">
    <h1 class="text-2xl font-bold text-blue-700">Gestão de OS</h1>
    <button onclick="fazerLogout()" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
        Sair do Sistema
    </button>
</div>
    
    <div class="container mx-auto max-w-5xl">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="md:col-span-1 no-print">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-4 text-blue-600">Nova Ordem (Nuvem)</h2>
                    <div class="space-y-3">
                        <input type="text" id="cliente" placeholder="Nome do Cliente" class="w-full border p-2 rounded text-sm">
                        <input type="text" id="contato" placeholder="Telefone" class="w-full border p-2 rounded text-sm">
                        <input type="text" id="equipamento" placeholder="Equipamento" class="w-full border p-2 rounded text-sm">
                        <textarea id="descricao" placeholder="Descrição" class="w-full border p-2 rounded text-sm h-20"></textarea>
                        <input type="number" id="valor" placeholder="Valor R$" class="w-full border p-2 rounded text-sm">
                        <button onclick="salvarNoSupabase()" id="btn-salvar" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700">
                            Salvar na Nuvem
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md mt-6">
    <h3 class="font-bold mb-3 border-b pb-2">Histórico na Nuvem</h3>
    
    <div class="mb-4">
        <input type="text" id="busca" onkeyup="filtrarOrdens()" placeholder="Buscar cliente ou OS..." 
               class="w-full border p-2 rounded text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none">
    </div>

    <ul id="lista-os" class="space-y-2 text-sm max-h-64 overflow-y-auto">
        </ul>
</div>
            </div>

            <div class="md:col-span-2">
                <div id="area-os" class="bg-white p-8 rounded shadow-lg hidden">
                    <div class="flex justify-between border-b-2 border-gray-800 pb-4 mb-6">
                        <h1 class="text-2xl font-bold uppercase">Ordem de Serviço</h1>
                        <p class="text-xs">Nº: <span id="view-numero"></span></p>
                    </div>
                    <div id="conteudo-view" class="text-sm space-y-4">
                        <p><strong>Cliente:</strong> <span id="view-cliente"></span></p>
                        <p><strong>Equipamento:</strong> <span id="view-equipamento"></span></p>
                        <p><strong>Descrição:</strong> <span id="view-descricao"></span></p>
                        <p class="text-lg font-bold pt-4">Valor: R$ <span id="view-valor"></span></p>
                    </div>
                    <button onclick="window.print()" class="no-print mt-6 bg-green-600 text-white px-4 py-1 rounded">Imprimir</button>
                </div>
            </div>
        </div>
    </div>

   <script>
    // 1. CONFIGURAÇÃO ÚNICA (Centralizada)
    const SUPABASE_URL = 'https://awuuucqzhgmyuolqrifm.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_M5bgMFw0R1rWLe5nfofFeg_NwLkjbBh'; // Use sua Anon Key real aqui
    const supaClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    console.log("Script carregado e Supabase inicializado!");

    // 2. FUNÇÕES DE AUTENTICAÇÃO
    async function fazerLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-senha').value;

        try {
            const { data, error } = await supaClient.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) throw error;
            
            console.log("Login realizado!");
            verificarSessao();
        } catch (err) {
            alert("Erro no login: " + err.message);
        }
    }

    async function verificarSessao() {
        const { data: { session } } = await supaClient.auth.getSession();
        const telaLogin = document.getElementById('tela-login');

        if (session) {
            telaLogin.classList.add('hidden'); 
            carregarOrdens(); 
        } else {
            telaLogin.classList.remove('hidden');
        }
    }

    async function fazerLogout() {
        await supaClient.auth.signOut();
        window.location.reload(); // Recarrega para limpar a memória
    }

    // 3. FUNÇÕES DE DADOS (CRUD)
    async function salvarNoSupabase() {
        const btn = document.getElementById('btn-salvar');
        const nomeCliente = document.getElementById('cliente').value;
        
        if (!nomeCliente) return alert("O nome do cliente é obrigatório!");

        try {
            btn.innerText = "Processando...";
            btn.disabled = true;

            const dados = {
                numero_os: 'OS-' + Math.floor(Math.random() * 10000),
                cliente: nomeCliente,
                contato: document.getElementById('contato').value,
                equipamento: document.getElementById('equipamento').value,
                descricao: document.getElementById('descricao').value,
                valor: parseFloat(document.getElementById('valor').value) || 0
            };

            const { error } = await supaClient.from('ordens_de_servico').insert([dados]);
            if (error) throw error;

            alert("OS salva com sucesso!");
            limparCampos();
            carregarOrdens();
        } catch (err) {
            alert("Erro: " + err.message);
        } finally {
            btn.innerText = "Salvar na Nuvem";
            btn.disabled = false;
        }
    }

    async function carregarOrdens() {
        try {
            const { data, error } = await supaClient
                .from('ordens_de_servico')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;

            const lista = document.getElementById('lista-os');
            lista.innerHTML = data.map(os => `
                <li class="p-2 border rounded hover:bg-blue-50 cursor-pointer flex justify-between items-center" onclick='verOS(${JSON.stringify(os)})'>
                    <span class="font-medium">${os.numero_os} - ${os.cliente}</span>
                    <button onclick="event.stopPropagation(); excluirOS(${os.id})" class="text-red-500 font-bold ml-2 text-lg">×</button>
                </li>
            `).join('');
        } catch (err) {
            console.error("Erro ao carregar lista:", err);
        }
    }

    // 4. AUXILIARES
    function verOS(os) {
        document.getElementById('view-numero').innerText = os.numero_os;
        document.getElementById('view-cliente').innerText = os.cliente;
        document.getElementById('view-equipamento').innerText = os.equipamento;
        document.getElementById('view-descricao').innerText = os.descricao;
        document.getElementById('view-valor').innerText = Number(os.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        document.getElementById('area-os').classList.remove('hidden');
    }

    async function excluirOS(id) {
        if(confirm("Deseja excluir esta OS?")) {
            await supaClient.from('ordens_de_servico').delete().eq('id', id);
            carregarOrdens();
        }
    }

    function limparCampos() {
        ['cliente', 'contato', 'equipamento', 'descricao', 'valor'].forEach(id => document.getElementById(id).value = '');
    }

    function filtrarOrdens() {
        const termo = document.getElementById('busca').value.toLowerCase();
        const itens = document.querySelectorAll('#lista-os li');
        itens.forEach(item => {
            item.style.display = item.innerText.toLowerCase().includes(termo) ? "flex" : "none";
        });
    }

    // Início automático
    verificarSessao();
</script>
</body>

</html>



